<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE COLOSSEUM</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Georgia', serif; 
            background: linear-gradient(135deg, #0a0e27, #1a1a3e); 
            color: #fff; 
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            padding: 30px 20px;
            border-bottom: 3px solid #d4af37;
            background: rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .header h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #d4af37, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 4px;
            margin-bottom: 5px;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            top: 20px;
            left: 20px;
            transition: all 0.3s;
            display: none;
        }

        .logout-btn:hover { background: #ff5252; transform: scale(1.05); }

        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }

        .screen { display: none; animation: fadeIn 0.5s ease-in; }
        .screen.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
        }

        .login-box {
            background: rgba(212, 175, 55, 0.08);
            border: 3px solid #d4af37;
            padding: 60px 40px;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.3);
        }

        .login-box h2 {
            color: #d4af37;
            margin-bottom: 30px;
            font-size: 2.2em;
            letter-spacing: 2px;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #d4af37;
            border-radius: 8px;
            font-size: 1.1em;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            text-align: center;
        }

        .login-box input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .login-box button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #d4af37, #ffd700);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-box button:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(212, 175, 55, 0.8); }

        /* Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ */
        .teams-title {
            text-align: center;
            font-size: 2.5em;
            color: #d4af37;
            margin-bottom: 40px;
            letter-spacing: 2px;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .team-card {
            background: rgba(212, 175, 55, 0.08);
            border: 2px solid #d4af37;
            padding: 30px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .team-card:hover:not(.disabled):not(.completed) {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(212, 175, 55, 0.5);
            border-color: #ffd700;
        }

        .team-card.selected {
            background: rgba(212, 175, 55, 0.2);
            border-color: #ffd700;
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.8);
        }

        .team-card.completed {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .team-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .team-card h3 {
            color: #d4af37;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .team-members-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.95em;
            text-align: left;
        }

        .member-slot {
            padding: 8px;
            margin: 5px 0;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 5px;
        }

        .member-slot.leader {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            font-weight: bold;
        }

        .member-slot.empty {
            color: #aaa;
            font-style: italic;
        }

        .status-badge {
            margin-top: 15px;
            font-weight: bold;
            font-size: 0.95em;
        }

        .status-badge.available { color: #4CAF50; }
        .status-badge.full { color: #ff6b6b; }
        .status-badge.completed { color: #4CAF50; }

        .role-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .role-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .leader-btn {
            background: #ffd700;
            color: #000;
        }

        .leader-btn:hover { background: #ffed4e; }

        .member-btn {
            background: #d4af37;
            color: #000;
        }

        .member-btn:hover { background: #e0c158; }

        .leave-btn {
            background: #ff6b6b;
            color: white;
            width: 100%;
        }

        .leave-btn:hover { background: #ff5252; }

        .start-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #d4af37, #ffd700);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            display: none;
            transition: all 0.3s;
            margin-top: 30px;
        }

        .start-btn.show { display: block; }
        .start-btn:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(212, 175, 55, 0.8); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ø¯ÙŠ */
        .challenge-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
        }

        .challenge-container {
            background: rgba(0, 0, 0, 0.85);
            border: 3px solid #d4af37;
            padding: 60px;
            border-radius: 15px;
            max-width: 700px;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.5);
        }

        .timer-display {
            font-size: 3em;
            color: #ffd700;
            font-weight: bold;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .timer-display.warning {
            color: #ff6b6b;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .challenge-container h2 {
            color: #d4af37;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .team-info {
            font-size: 1.1em;
            color: #ffd700;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 8px;
        }

        .code-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #d4af37;
            border-radius: 8px;
            font-size: 1.3em;
            background: rgba(255, 255, 255, 0.05);
            color: #d4af37;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin: 20px 0;
        }

        .code-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .verify-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #d4af37, #ffd700);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .verify-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(212, 175, 55, 0.8); }

        .message {
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: bold;
            padding: 15px;
            border-radius: 8px;
            min-height: 30px;
        }

        .message.success {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .message.error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù„ÙØ§Øª */
        .files-screen {
            background: linear-gradient(135deg, #2a2520, #3d3935);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .files-container {
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #d4af37;
            padding: 50px;
            border-radius: 15px;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.5);
        }

        .files-title {
            color: #d4af37;
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 10px;
        }

        .files-subtitle {
            text-align: center;
            color: #ffd700;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .image-box {
            width: 100%;
            height: 250px;
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .image-box:hover { transform: scale(1.08); box-shadow: 0 10px 30px rgba(212, 175, 55, 0.5); }

        .image-box img { width: 100%; height: 100%; object-fit: cover; }

        .image-label {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(212, 175, 55, 0.95);
            color: #000;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .files-actions {
            text-align: center;
            margin-top: 40px;
        }

        .download-btn, .back-btn {
            padding: 15px 40px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .download-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .download-btn:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(76, 175, 80, 0.6); }

        .back-btn {
            background: #d4af37;
            color: #000;
        }

        .back-btn:hover { background: #ffd700; transform: scale(1.05); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© */
        .result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .result-modal.show {
            display: flex;
            animation: fadeIn 0.5s ease-in;
        }

        .result-card {
            background: linear-gradient(135deg, #1a3a3a, #0d2626);
            border: 3px solid #4CAF50;
            padding: 50px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            box-shadow: 0 0 60px rgba(76, 175, 80, 0.5);
        }

        .result-card h2 {
            color: #4CAF50;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .result-info {
            font-size: 1.3em;
            color: #ffd700;
            margin: 20px 0;
            padding: 15px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 8px;
        }

        .result-info strong { color: #4CAF50; }

        .close-result {
            margin-top: 30px;
            padding: 12px 30px;
            background: #d4af37;
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        .close-result:hover { background: #ffd700; transform: scale(1.05); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ */
        .admin-container {
            background: rgba(212, 175, 55, 0.1);
            border: 3px solid #d4af37;
            padding: 50px;
            border-radius: 15px;
            max-width: 600px;
            margin: 50px auto;
            text-align: center;
        }

        .admin-container h2 {
            color: #d4af37;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .admin-btn {
            width: 100%;
            padding: 15px;
            background: #d4af37;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 12px 0;
            font-weight: bold;
            transition: all 0.3s;
        }

        .admin-btn:hover { background: #ffd700; transform: scale(1.05); }

        .admin-btn.danger {
            background: #ff6b6b;
            color: white;
        }

        .admin-btn.danger:hover { background: #ff5252; }

        .stats-table {
            width: 100%;
            color: #d4af37;
            margin-top: 30px;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        .stats-table th {
            background: rgba(212, 175, 55, 0.2);
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #d4af37;
        }

        .stats-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .stats-table tr:hover { background: rgba(212, 175, 55, 0.05); }
    </style>
</head>
<body>
    <div class="header">
        <button class="logout-btn" id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        <h1>ğŸ›ï¸ THE COLOSSEUM</h1>
        <p style="color: #d4af37; margin-top: 5px; letter-spacing: 1px;">ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø´ÙØ±Ø§Øª</p>
    </div>

    <div class="container">
        <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… -->
        <div class="screen active" id="nameScreen">
            <div class="login-container">
                <div class="login-box">
                    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                    <input type="text" id="nameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" onkeypress="if(event.key==='Enter') goToTeams()">
                    <button onclick="goToTeams()">Ø¯Ø®ÙˆÙ„</button>
                </div>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ -->
        <div class="screen" id="teamsScreen">
            <h2 class="teams-title">ğŸ‘¥ Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h2>
            <div class="teams-grid" id="teamsGrid"></div>
            <button class="start-btn" id="startBtn" onclick="startChallenge()">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ</button>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ø¯ÙŠ -->
        <div class="screen" id="challengeScreen">
            <div class="challenge-screen">
                <div class="challenge-container">
                    <h2>ğŸ” Ø­Ù„ Ø§Ù„Ø´ÙØ±Ø©</h2>
                    <div class="team-info" id="challengeTeamInfo"></div>
                    <div class="timer-display" id="timerDisplay">02:00:00</div>
                    <input type="text" id="codeInput" class="code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´ÙØ±Ø©" onkeypress="if(event.key==='Enter') verifyCode()">
                    <button class="verify-btn" onclick="verifyCode()">âœ“ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´ÙØ±Ø©</button>
                    <div class="message" id="codeMessage"></div>
                    <button class="back-btn" onclick="backToTeams()" style="margin-top: 20px; width: 100%;">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                </div>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù„ÙØ§Øª -->
        <div class="screen files-screen" id="filesScreen">
            <div class="files-container">
                <h2 class="files-title">ğŸ“‹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¶ÙŠØ©</h2>
                <p class="files-subtitle" id="filesSubtitle"></p>
                <div class="images-grid" id="imagesGrid"></div>
                <div class="files-actions">
                    <button class="download-btn" onclick="downloadAllImages()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±</button>
                    <button class="back-btn" onclick="backToTeams()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙØ±Ù‚</button>
                </div>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ -->
        <div class="screen" id="adminScreen">
            <div class="admin-container">
                <h2>ğŸ” Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h2>
                <button class="admin-btn" onclick="showStats()">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
                <button class="admin-btn" onclick="resetTimer()">â±ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆÙ‚Øª</button>
                <button class="admin-btn danger" onclick="resetGame()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
                <button class="admin-btn" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
            <div id="statsContainer"></div>
        </div>
    </div>

    <!-- Modal Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
    <div class="result-modal" id="resultModal">
        <div class="result-card">
            <h2>ğŸ‰ ØªÙ… Ø­Ù„ Ø§Ù„Ø´ÙØ±Ø©!</h2>
            <div class="result-info">Ø§Ù„ÙØ±ÙŠÙ‚: <strong id="resultTeamNum"></strong></div>
            <div class="result-info">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: <strong id="resultErrors"></strong></div>
            <div class="result-info">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: <strong id="resultTime"></strong></div>
            <button class="close-result" onclick="closeResult()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gcneuinmgyisevkjgssw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjbmV1aW5tZ3lpc2V2a2pnc3N3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Njc5MDEsImV4cCI6MjA4NDI0MzkwMX0.9SiHd6BXVYJYP14fqJvp6E0kJr1T2TLqL-0lhzL9Sns';
        const ADMIN_PASSWORD = 'ADMIN2024';
        const TOTAL_TIME = 7200;
        const PENALTY = 900;

        let supabaseClient = null;
        let currentUser = null;
        let currentTeam = null;
        let allTeams = [];
        let gameStarted = false;
        let timeLeft = TOTAL_TIME;
        let timerInterval = null;
        let startTime = null;

        // ØªÙ‡ÙŠØ¦Ø© Supabase
        function initSupabase() {
            const { createClient } = window.supabase;
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('âœ… Supabase Ù…ØªØµÙ„');
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function goToTeams() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) { 
                alert('âŒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ'); 
                return; 
            }

            if (name === ADMIN_PASSWORD) {
                document.getElementById('logoutBtn').style.display = 'block';
                showScreen('adminScreen');
                await showStats();
                return;
            }

            currentUser = name;
            document.getElementById('logoutBtn').style.display = 'block';
            await loadTeams();
            showScreen('teamsScreen');
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±Ù‚
        async function loadTeams() {
            try {
                const { data, error } = await supabaseClient
                    .from('teams')
                    .select('*, team_members(username, role)');

                if (error) throw error;
                allTeams = data || [];
                renderTeams();
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø£:', err);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„ÙØ±Ù‚
        function renderTeams() {
            const grid = document.getElementById('teamsGrid');
            grid.innerHTML = '';

            allTeams.forEach(team => {
                const members = team.team_members || [];
                const leader = members.find(m => m.role === 'leader');
                const membersList = members.filter(m => m.role === 'member');
                const isUserMember = members.some(m => m.username === currentUser);
                const isFull = members.length >= 4;
                const isDisabled = (isFull && !isUserMember) || team.solved;

                const card = document.createElement('div');
                card.className = `team-card ${isUserMember ? 'selected' : ''} ${team.solved ? 'completed' : ''} ${isDisabled ? 'disabled' : ''}`;

                let membersHTML = `
                    <div class="team-members-info">
                        <div class="member-slot ${leader ? 'leader' : 'empty'}">
                            ${leader ? `ğŸ‘‘ Ù‚Ø§Ø¦Ø¯: ${leader.username}` : 'ğŸ‘‘ Ù‚Ø§Ø¦Ø¯: ØºÙŠØ± Ù…Ø­ØªÙ„'}
                        </div>
                        ${[0, 1, 2].map(i => {
                            const member = membersList[i];
                            return `<div class="member-slot ${member ? '' : 'empty'}">
                                ${member ? `ğŸ‘¤ Ø¹Ø¶Ùˆ: ${member.username}` : `ğŸ‘¤ Ø¹Ø¶Ùˆ ${i + 1}: ÙØ§Ø±Øº`}
                            </div>`;
                        }).join('')}
                    </div>
                `;

                let statusHTML = '';
                if (team.solved) {
                    statusHTML = '<div class="status-badge completed">âœ… Ù…ÙƒØªÙ…Ù„</div>';
                } else if (isFull) {
                    statusHTML = '<div class="status-badge full">ğŸ”’ Ø§Ù„ÙØ±ÙŠÙ‚ Ù…Ù…ØªÙ„Ø¦</div>';
                } else {
                    statusHTML = '<div class="status-badge available">âœ… Ù…ØªØ§Ø­</div>';
                }

                let actionHTML = '';
                if (!team.solved) {
                    if (isUserMember) {
                        actionHTML = '<button class="role-btn leave-btn" onclick="leaveTeam(' + team.id + ')">âŒ ØºØ§Ø¯Ø± Ø§Ù„ÙØ±ÙŠÙ‚</button>';
                    } else if (!isDisabled) {
                        actionHTML = `
                            <div class="role-buttons">
                                <button class="role-btn leader-btn" onclick="joinTeamAs(${team.id}, 'leader')">ğŸ‘‘ Ù‚Ø§Ø¦Ø¯</button>
                                <button class="role-btn member-btn" onclick="joinTeamAs(${team.id}, 'member')">ğŸ‘¤ Ø¹Ø¶Ùˆ</button>
                            </div>
                        `;
                    }
                }

                card.innerHTML = `
                    <h3>ğŸ¯ Ø§Ù„ÙØ±ÙŠÙ‚ ${team.number}</h3>
                    ${membersHTML}
                    ${statusHTML}
                    <div class="team-actions">${actionHTML}</div>
                `;

                grid.appendChild(card);
            });
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¨Ø±ØªØ¨Ø©
        async function joinTeamAs(teamId, role) {
            const team = allTeams.find(t => t.id === teamId);
            const members = team.team_members || [];

            if (role === 'leader' && members.some(m => m.role === 'leader')) {
                alert('âŒ Ø§Ù„ÙØ±ÙŠÙ‚ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ø¯ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·');
                return;
            }

            if (role === 'member' && members.filter(m => m.role === 'member').length >= 3) {
                alert('âŒ Ø§Ù„ÙØ±ÙŠÙ‚ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 3 Ø£Ø¹Ø¶Ø§Ø¡ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('team_members')
                    .insert([{ team_id: teamId, username: currentUser, role: role }]);

                if (error) throw error;

                currentTeam = team;
                document.getElementById('startBtn').classList.add('show');
                await loadTeams();
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø£:', err);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…');
            }
        }

        // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚
        async function leaveTeam(teamId) {
            try {
                const { error } = await supabaseClient
                    .from('team_members')
                    .delete()
                    .eq('team_id', teamId)
                    .eq('username', currentUser);

                if (error) throw error;

                currentTeam = null;
                document.getElementById('startBtn').classList.remove('show');
                await loadTeams();
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø£:', err);
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ
        async function startChallenge() {
            if (!currentTeam) {
                alert('âŒ Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            if (!gameStarted) {
                gameStarted = true;
                timeLeft = TOTAL_TIME;
                startTime = Date.now();
                startTimer();
            }

            document.getElementById('challengeTeamInfo').textContent = `ğŸ¯ Ø§Ù„ÙØ±ÙŠÙ‚: ${currentTeam.number}`;
            document.getElementById('codeInput').value = '';
            document.getElementById('codeMessage').innerHTML = '';
            showScreen('challengeScreen');
            document.getElementById('codeInput').focus();
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                timeLeft = Math.max(0, TOTAL_TIME - elapsed);
                updateTimer();

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert('â±ï¸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!');
                }
            }, 100);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ù‚Øª
        function updateTimer() {
            const hours = Math.floor(timeLeft / 3600);
            const minutes = Math.floor((timeLeft % 3600) / 60);
            const seconds = timeLeft % 60;
            const display = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            const timerEl = document.getElementById('timerDisplay');
            if (timerEl) {
                timerEl.textContent = display;
                if (timeLeft < 300) {
                    timerEl.classList.add('warning');
                } else {
                    timerEl.classList.remove('warning');
                }
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´ÙØ±Ø©
        async function verifyCode() {
            const input = document.getElementById('codeInput').value.toUpperCase().trim();
            const correctCode = currentTeam.code;
            const msg = document.getElementById('codeMessage');

            if (input === correctCode) {
                msg.innerHTML = 'âœ… ØµØ­ÙŠØ­! ØªÙ… ÙØªØ­ Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¶ÙŠØ©';
                msg.className = 'message success';

                try {
                    await supabaseClient
                        .from('teams')
                        .update({ solved: true, solve_time: new Date() })
                        .eq('id', currentTeam.id);
                } catch (err) {
                    console.error('âŒ Ø®Ø·Ø£:', err);
                }

                setTimeout(() => showFiles(), 1500);
            } else {
                const attempts = (currentTeam.attempts || 0) + 1;

                try {
                    await supabaseClient
                        .from('teams')
                        .update({ attempts: attempts })
                        .eq('id', currentTeam.id);

                    timeLeft = Math.max(0, timeLeft - PENALTY);
                    updateTimer();
                } catch (err) {
                    console.error('âŒ Ø®Ø·Ø£:', err);
                }

                if (attempts >= 3) {
                    msg.innerHTML = 'âŒ Ø§Ù†ØªÙ‡Øª Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ! (3/3)';
                    msg.className = 'message error';
                    setTimeout(() => backToTeams(), 2000);
                } else {
                    msg.innerHTML = `âŒ Ø®Ø·Ø£!<br>Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${3 - attempts}<br>âš ï¸ -15 Ø¯Ù‚ÙŠÙ‚Ø©`;
                    msg.className = 'message error';
                    document.getElementById('codeInput').value = '';
                    document.getElementById('codeInput').focus();
                }
            }
        }

        // Ø¹Ø±Ø¶ Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¶ÙŠØ©
        function showFiles() {
            document.getElementById('filesSubtitle').textContent = `ğŸ¯ Ø§Ù„ÙØ±ÙŠÙ‚ ${currentTeam.number} - ${currentTeam.attempts || 0} Ø£Ø®Ø·Ø§Ø¡`;

            const grid = document.getElementById('imagesGrid');
            grid.innerHTML = '';

            for (let i = 1; i <= 8; i++) {
                const box = document.createElement('div');
                box.className = 'image-box';
                box.innerHTML = `
                    <img src="https://via.placeholder.com/300x400?text=Case+${currentTeam.number}+File+${i}" alt="Ù…Ù„Ù ${i}">
                    <div class="image-label">Ù…Ù„Ù ${i}</div>
                `;
                grid.appendChild(box);
            }

            showResultModal();
            showScreen('filesScreen');
        }

        // Ø¹Ø±Ø¶ Modal Ø§Ù„Ù†ØªÙŠØ¬Ø©
        function showResultModal() {
            document.getElementById('resultTeamNum').textContent = currentTeam.number;
            document.getElementById('resultErrors').textContent = currentTeam.attempts || 0;

            const timeTaken = TOTAL_TIME - timeLeft;
            const hours = Math.floor(timeTaken / 3600);
            const minutes = Math.floor((timeTaken % 3600) / 60);
            const seconds = timeTaken % 60;
            const timeUsed = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('resultTime').textContent = timeUsed;

            document.getElementById('resultModal').classList.add('show');
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        function closeResult() {
            document.getElementById('resultModal').classList.remove('show');
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
        function downloadAllImages() {
            alert('ğŸ“¥ Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù‚Ø±ÙŠØ¨Ø§Ù‹');
        }

        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙØ±Ù‚
        async function backToTeams() {
            closeResult();
            await loadTeams();
            showScreen('teamsScreen');
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        async function showStats() {
            try {
                const { data: teams, error } = await supabaseClient
                    .from('teams')
                    .select('*');

                if (error) throw error;

                let html = '<h3 style="color: #d4af37; margin-top: 30px; font-size: 1.5em;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h3>';
                html += '<table class="stats-table"><tr><th>Ø§Ù„ÙØ±ÙŠÙ‚</th><th>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</th></tr>';

                for (const team of teams) {
                    const { data: members } = await supabaseClient
                        .from('team_members')
                        .select('id')
                        .eq('team_id', team.id);

                    const count = members ? members.length : 0;
                    const status = team.solved ? 'âœ… Ù…ÙƒØªÙ…Ù„' : 'âŒ Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„';
                    html += `<tr><td>Ø§Ù„ÙØ±ÙŠÙ‚ ${team.number}</td><td>${count}/4</td><td>${status}</td><td>${team.attempts || 0}</td></tr>`;
                }

                html += '</table>';
                document.getElementById('statsContainer').innerHTML = html;
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø£:', err);
            }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆÙ‚Øª
        async function resetTimer() {
            if (!confirm('âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆÙ‚ØªØŸ')) return;

            gameStarted = false;
            timeLeft = TOTAL_TIME;
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            updateTimer();

            alert('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆÙ‚Øª');
            await showStats();
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©
        async function resetGame() {
            if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!')) return;

            try {
                await supabaseClient.from('team_members').delete().neq('id', 0);
                await supabaseClient.from('teams').update({ solved: false, attempts: 0, solve_time: null }).neq('id', 0);

                gameStarted = false;
                timeLeft = TOTAL_TIME;
                if (timerInterval) clearInterval(timerInterval);

                alert('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©');
                await showStats();
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø£:', err);
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        function logout() {
            currentUser = null;
            currentTeam = null;
            document.getElementById('nameInput').value = '';
            document.getElementById('logoutBtn').style.display = 'none';
            if (timerInterval) clearInterval(timerInterval);
            gameStarted = false;
            showScreen('nameScreen');
        }

        // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø§Øª
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        window.addEventListener('DOMContentLoaded', initSupabase);
    </script>
</body>
</html>
